{"version":3,"file":"index.mjs","sources":["../../../../../src/libs/utils.ts","../../../../../src/libs/routerRef.ts","../../../../../src/libs/router.ts","../../../../../src/libs/injectRouter.ts"],"sourcesContent":["import {Callback} from './types'\n\nexport function registerHook(list:Callback[], fn:Callback) {\n  list.push(fn);\n  return () => {\n    //等待调用的时候从中取出\n    const i = list.indexOf(fn);\n    if (i > -1) list.splice(i, 1);\n  };\n}\n\n\nexport function runQueue(queue:Callback[], fn:Callback, cb:Callback) {\n  const step = (index: number) => {\n    if (index >= queue.length) {\n      cb();\n    } else {\n      if (queue[index]) {\n        fn(queue[index], () => {\n          step(index + 1);\n        });\n      } else {\n        step(index + 1);\n      }\n    }\n  };\n  step(0);\n}\n\n","\nexport const routerRef = {\n  ref: {} ,\n};\n","import {\n  RouteConfigRaw,\n  RouteOptions,\n  RouteNameOptions,\n  CallbackResult,\n  Callback,\n  RouteBackOptions,\n} from \"./types\";\n\nimport { registerHook, runQueue } from \"./utils\";\n\nimport { routerRef } from \"./routerRef\";\n\nclass Router {\n  constructor(routes: RouteConfigRaw[]) {\n    this.routes = routes;\n  }\n\n  private params: any = null;\n  private routes: RouteConfigRaw[];\n  private route = {} as RouteOptions | RouteBackOptions;\n  private toRoute = {} as RouteOptions | RouteBackOptions;\n\n  private beforeHooks: Callback[] = [];\n  private afterHooks: Callback[] = [];\n\n  beforeEnter(fn: Callback) {\n    registerHook(this.beforeHooks, fn);\n  }\n\n  afterEnter(fn: Callback) {\n    registerHook(this.afterHooks, fn);\n  }\n\n  push(r: RouteOptions) {\n    if (!r.name && !r.path) {\n      return;\n    }\n    this.params = r.params;\n    return new Promise((resolve, reject) => {\n      const route = this.routes.filter(\n        (item) => item.name === r.name || item.path === r.path\n      )[0];\n      setTimeout(() => {\n        if (route.type === \"tab\") {\n          (wx as any)[route.type === \"tab\" ? \"switchTab\" : \"navigateTo\"]({\n            url: route.path,\n            success: (res: CallbackResult) => resolve(res),\n            fail: (err: CallbackResult) => reject(err),\n          });\n        }\n      }, r.delay ?? 0);\n    });\n  }\n\n  replace(r: RouteOptions) {\n    if (!r.name && !r.path) {\n      return;\n    }\n    this.params = r.params;\n    return new Promise((resolve, reject) => {\n      const route = this.routes.filter(\n        (item) => item.name === r.name || item.path === r.path\n      )[0];\n      setTimeout(() => {\n        wx.redirectTo({\n          url: route.path,\n          success: (res: CallbackResult) => resolve(res),\n          fail: (err: CallbackResult) => reject(err),\n        });\n      }, r.delay ?? 0);\n    });\n  }\n\n  back(r: RouteBackOptions) {\n    if (!r.name && !r.path && !r.level) {\n      return;\n    }\n    this.params = r.params;\n    const route = this.routes.filter(\n      (item) => item.name === r.name || item.path === r.path\n    )[0];\n\n    let l: number;\n\n    // level parameter first\n    if (r.level) l = r.level;\n\n    return new Promise((resolve, reject) => {\n      setTimeout(() => {\n        wx.navigateBack({\n          delta: l,\n          success: (res: CallbackResult) => resolve(res),\n          fail: (err: CallbackResult) => reject(err),\n        });\n      }, r.delay ?? 0);\n    });\n  }\n\n  reLaunch(r: RouteOptions) {\n    if (!r.name && !r.path) {\n      return;\n    }\n    this.params = r.params;\n    return new Promise((resolve, reject) => {\n      const route = this.routes.filter(\n        (item) => item.name === r.name || item.path === r.path\n      )[0];\n      setTimeout(() => {\n        wx.reLaunch({\n          url: route.path,\n          success: (res: CallbackResult) => resolve(res),\n          fail: (err: CallbackResult) => reject(err),\n        });\n      }, r.delay ?? 0);\n    });\n  }\n\n  private getPage(index = 1) {\n    const pages = getCurrentPages();\n    return pages[pages.length - index];\n  }\n\n  getCurrPage() {\n    return this.getPage(1);\n  }\n\n  getPrevPage() {\n    return this.getPage(2);\n  }\n\n  getParams() {\n    const p = this.params;\n    this.params = null;\n    return p;\n  }\n}\n\nconst routes: RouteConfigRaw[] = [\n  {\n    name: \"index\",\n    type: \"tab\",\n    path: \"/pages/index/index\",\n  },\n  {\n    name: \"index\",\n    path: \"/pages/index/index\",\n  },\n];\n\nexport function createRouter(config: { routes: RouteConfigRaw[] }) {\n  const router = new Router(config.routes);\n  routerRef.ref = router;\n  return router;\n}\n","import { routerRef } from \"./routerRef\";\n\nimport { AppOptions, PageOptions, ComponentOptions } from \"./types\";\n\nexport function injectRouter() {\n  const originApp = App;\n  App = function (options: AppOptions) {\n    const newOptions = {\n      ...options,\n      onLaunch(o: WechatMiniprogram.App.LaunchShowOption) {\n        this.$router = routerRef.ref;\n        options?.onLaunch?.call(this, o);\n      },\n    } as AppOptions;\n\n    return originApp(newOptions);\n  } as any;\n\n  const OriginPage = Page;\n  Page = function (options: PageOptions) {\n    const newOptions: PageOptions = {\n      ...options,\n      onLoad(o) {\n        this.$router = routerRef.ref;\n        options?.onLoad?.call(this, o);\n      },\n    };\n    return OriginPage(newOptions);\n  } as any;\n\n  const OriginComponent = Component;\n  Component = function (options: ComponentOptions) {\n    const newOptions: ComponentOptions = {\n      ...options,\n      attached() {\n        this.$router = routerRef.ref;\n        options?.attached?.call(this);\n      },\n      lifetimes: {\n        attached() {\n          this.$router = routerRef.ref;\n          options?.lifetimes?.attached?.call(this);\n        },\n      },\n    };\n\n    return OriginComponent(newOptions);\n  } as any;\n}\n"],"names":[],"mappings":"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"}